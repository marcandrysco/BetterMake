#!/bin/sh

##
# extract Function
#   Given a chunk of a file, it extracts the quoted option value given the
#   option name.
# Parameters
#   string text
#     The input text to be parsed.
#   string optname
#     The name of the option to extract.
#.

extract()
{
	printf %s "$1" | sed -n 's/^\s'"$2"'\s*"\(.*\)"\s*$/\1/p'
}

##
# process_sources Function
#   Inputs the sources configuration file and produces the corresponding
#   makefile.
# Parameters
#   string infile
#     The name of the input sources file.
#   string outfile
#     The name of the output makefile.
#.

process_sources()
{
	local remaining="`cat "$1"`"

	rm -f "$2"

	clean=""	# Cleaning commands
	objlist=""	# List of all object files
	depdirlist=""	# List of dependency directories

	while [ 1 ]
	do
		local copy="`printf %s "$remaining" | sed '/^\s*EndTarget\s*$/,$d'`"
		test "$copy" = "$remaining" && break

		cdeps="";				# C Dependencies
		targetdeps=""				# Target Dependencies
		cflags=" `extract "$copy" CFlags`"	# C Flags
		ldflags=" `extract "$copy" LDFlags`"	# Linker Flags

		local target="`extract "$copy" Name`"
		local type="`extract "$copy" Type`"
		local local="`extract "$copy" Local`"
		local version="`extract "$copy" Version`"
		local sources="`extract "$copy" Source`"
		local obj="`printf %s "$sources" | sed 's/.c\(pp\)\?$/.o/'`"
		obj="`echo -n $obj`"

		test -z "$version" && version="0.0.0"
		local shortversion="${version%%.*}"

		case "$local" in
			[Tt][Rr][Uu][Ee] | [Yy][Ee][Ss] )
				prefix="$HOME"
				bindir="$HOME/bin"
				libdir="$HOME/bin"
				sharedir="$HOME/bin"
				cflags="$cflags -I\"$HOME/include\""
				ldflags="$ldflags -L\"$HOME/lib\" -Wl,-rpath=\"$HOME/lib\""
				;;

			[Ff][Aa][Ll][Ss][Ee] | [Nn][Oo] | "")
				;;

			*)
				echo "invalid local value \"$local\"" >&2
				exit 1
		esac

		# Precompiled header handling
		pch="`extract "$copy" PCH`"
		if [ -n "$pch" ] ; then
			printf '%s.gch: %s%s\n' "$pch" "$pch" "$cdeps" >> "$2"
			printf '\t$(bmake_PRECC)\n' >> "$2"
			printf '\t$(CC) $(CFLAGS)%s -c $< -o $@\n\n' "$cflags" >> "$2"

			clean="$clean`printf '\n\trm -f %s.gch\n' "$pch"`"
			cdeps="$cdeps $pch.gch"
		fi

		case "$type" in
			"Application" | "" )
				printf 'bmake_all: %s\n\n' "$target" >> "$2"
				printf '%s: %s%s\n' "$target" "$obj" "$targetdeps" >> "$2"
				printf '\t%s\n\n' "`printf '$(LD)%s $^ -o $@ $(LDFLAGS)\n' "$ldflags"`" >> "$2"
				printf 'bmake_install: %s_install\n\n' "$target" >> "$2"
				printf '%s_install:\n\tinstall --mode 0755 -D %s "%s/%s"\n\n' "$target" "$target" "$bindir" "$target" >> "$2"
				clean="$clean`printf '\n\trm -f %s\n' "$target"`"
				local ldextra=''
				;;

			"TestApplication")
				local deps="`extract "$copy" Deps`"
				printf 'bmake_test: %s_test\n\n' "$target" >> "$2"
				printf '%s_test: %s\n' "$target" "$target" >> "$2"
				printf '\t@./%s || echo "**** %s failed ****"\n\n' "$target" "$target" >> "$2"
				printf '%s: %s %s| all\n' "$target" "$obj" "$deps">> "$2"
				printf '\t%s\n\n' "`printf '$(LD)%s %s -o $@ $(LDFLAGS)\n' "$ldflags" "$obj"`" >> "$2"
				clean="$clean`printf '\n\trm -f %s\n' "$target"`"
				local ldextra=''
				;;

			"Library")
				printf 'bmake_all: lib%s.a lib%s.so.%s\n\n' "$target" "$target" "$version" >> "$2"
				printf 'lib%s.a: %s\n\t%s\n\n' "$target" "$obj" "`printf 'ar rcs $@ $^'`" >> "$2"
				printf 'lib%s.so.%s: %s\n' "$target" "$version" "$obj" >> "$2"
				printf '\t$(CC)%s -fpic -shared -Wl,-soname,lib%s.so.%s -o $@ $^\n' "$ldflags" "$target" "$shortversion" >> "$2"
				printf '\tln -fs lib%s.so.%s lib%s.so.%s\n' "$target" "$version" "$target" "$shortversion" >> "$2"
				printf '\tln -fs lib%s.so.%s lib%s.so\n\n' "$target" "$version" "$target" >> "$2"
				printf 'bmake_install: lib%s_install\n\n' "$target" >> "$2"
				printf 'lib%s_install: lib%s.a lib%s.so.%s\n' "$target" "$target" "$target" "$version" >> "$2"
				printf '\tinstall --mode 0644 -D lib%s.a "%s/lib%s.a"\n' "$target" "$libdir" "$target" >> "$2"
				printf '\tinstall --mode 0755 -D lib%s.so.%s "%s/lib%s.so.%s"\n' "$target" "$version" "$libdir" "$target" "$version" >> "$2"
				printf '\tln -fs lib%s.so.%s "%s/lib%s.so"\n' "$target" "$version" "$libdir" "$target" >> "$2"
				printf '\tln -fs lib%s.so.%s "%s/lib%s.so.%s"\n\n' "$target" "$version" "$libdir" "$target" "$shortversion" >> "$2"
				clean="$clean`printf '\n\trm -f lib%s.a lib%s.so.%s lib%s.so.%s lib%s.so' "$target" "$target" "$version" "$target" "$shortversion" "$target"`"
				local ldextra=' -fpic'
				;;

			*)
				echo "invalid target type" >&2 ; exit 1 ;;
		esac

		for file in $sources
		do
			objfile="`printf %s "$file" | sed 's/.c\(pp\)\?$/.o/'`"
			objlist="$objlist $objfile"

			printf '%s: %s%s\n' "$objfile" "$file" "$cdeps" >> "$2"
			printf '\t$(bmake_PRECC)\n' >> "$2"
			printf '\t$(CC)%s -c $< -o $@ $(CFLAGS)%s\n\n' "$cflags" "$ldextra" >> "$2"

			# Add depdir if not in list
			depdir="${file%/*}/deps"
			test "${depdirlist%" $depdir"}" = "$depdirlist" && depdirlist="$depdirlist $depdir"
		done

		#printf '%s_clean:\n%s\n\trm -f %s\n\n.PHONY: %s_clean\n\n' "$target" "$clean" "$obj" "$target" >> "$2"

		remaining=`printf %s "$remaining" | sed '1,/^\s*EndTarget\s*$/d'`
	done

	test "$objlist" && clean="$clean`printf '\n\trm -f%s' "${objlist% }"`"
	test "$depdirlist" && clean="$clean`printf '\n\trm -rf%s' "${depdirlist% }"`"

	printf 'bmake_clean:%s\n\n' "$clean" >> "$2"
	printf '.PNOHY: bmake_clean\n' >> "$2"
}

config="config.h"
test -e "src" && config="src/$config"

prefix="/usr/local"
bindir=""
libdir=""
sharedir=""

for opt in "$@"
do
	if [ -z "$optname" ] ; then
		if [ "$opt" != "${opt%%=*}" ] ; then
			optname=${opt%%=*}
			opt=${opt#*=} 
		else
			optname="$opt"
			unset opt
		fi
	fi

	case "$optname" in
		--build)
			test -z "$opt" && continue ; build="$opt" ;;

		--host)
			test -z "$opt" && continue ; host="$opt" ;;

		--prefix | --libdir | --bindir )
			test -z "$opt" && continue ; eval "${optname%--}\"\$opt\"" ;;

		*)
			echo "invalid option $optname"
			exit 1
			;;
	esac

	unset optname
done

test -z "$bindir" && bindir="$prefix/bin"
test -z "$libdir" && libdir="$prefix/lib"
test -z "$sharedir" && sharedir="$prefix/share"

test ! -z $optname && echo "'$optname' requires parameter" && exit 1

test -z "$prefix" && prefix="/usr/bin"

process_sources sources sources.mk

unset BMAKE_DECL

build_config_h()
{
	cat <<EOF > "$config"
#ifndef CONFIG_H
#define CONFIG_H

#define BMAKE__PATH_PREFIX	"$prefix"
#define BMAKE__PATH_BIN		"$bindir"
#define BMAKE__PATH_LIB		"$libdir"
#define BMAKE__PATH_SHARE	"$sharedir"

EOF
}

build_config_h

for script in mktests/[0-9][0-9]*
do
	test ! -f "$script" && continue
	rm -f mktests/tmp*
	. $script || exit $?
done
rm -f mktests/tmp*

echo "#endif" >> "$config"

reconf="$0"
for param in "$@" ; do reconf="$reconf '$param'" ; done
echo "$reconf" > config.status
chmod +x config.status

if [ -e "$make" ] ; then
	if ! rm -f "$make" < /dev/null > /dev/null 2> /dev/null ; then
		echo Unable to remove "$make"
		exit
	fi
fi

cat <<EOF > "Makefile"
# autogenerated by configure script
bmake_PRECC =
bmake_CFLAGS = 
bmake_LDFLAGS = 
bmake_reconfigure = $reconf
bmake_PREFIX = $prefix
$BMAKE_DECL
# end autogenerated content
EOF

cat "Makefile.in" >> "Makefile"

cat <<EOF >> "Makefile"
# autogenerated by configure script
bmake-all:

bmake-clean:
	rm Makefile $config
# end autogenerated content
EOF
