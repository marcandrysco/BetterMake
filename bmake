#!/bin/sh

sharedir='.'

usage()
{
	if [ "$#" -eq 0 ] ; then
		fd=1
	else
		fd=$1
	fi

	cat <<EOF >&$fd
bmake command [options]

Possible commands are:
  install
  update
  source add
  source remove
  source list
EOF
}

copyfile()
{
	echo "# Generated by BetterMake" > "$1"
	echo "# md5sum: "`md5sum "$sharedir/bmake/$1" | head -c32` >> "$1"
	echo >> "$1"
	cat "$sharedir/bmake/$1" >> "$1"

	test ! -z "$2" && chmod "$2" "$1"
}

if [ "$#" -eq 0 ] ; then
	usage
	exit
fi

cmd=$1; shift;

case "$cmd" in
	install)
		for file in "Makefile.in" "configure"
		do
			test -e "$file" || continue

			echo "$file already exists, cowardly giving up" >&2
			exit 1
		done

		copyfile "Makefile.in"
		copyfile "configure" 0755

		;;
	
	help)
		usage
		;;

	*)
		usage 2
		exit 1
		;;
esac

for opt in "$@"
do
	if [ -z "$optname" ] ; then
		if [ "$opt" != "${opt%%=*}" ] ; then
			optname=${opt%%=*}
			opt=${opt#*=} 
		else
			optname="$opt"
			unset opt
		fi
	fi

	case "$optname" in
		--check)
			test -n "$mode" && echo "mode already selected" >&2 && exit 1
			mode="check"
			;;

		*)
			echo "invalid option $optname" >&2
			exit 1
			;;
	esac

	unset optname
done

test -z "$mode" && mode="check"

case "$mode" in
	"check")
		;;

	*)
		echo "invalid mode" >&2
		exit 1;
esac
